# Check that each package/*/LICENSE is consistent with LICENSE.
#
# - If it does not exist, make a copy of the LICENSE.
# - If there is an inconsistency, overwrite with LICENSE.
name: License Consistency
on: [push]
jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: dart-lang/setup-dart@v1.3
      - name: Install dependencies
        run: dart pub get
        working-directory: tools
      - name: Fix license consistency
        run: dart run tools/license_consistency.dart -l LICENSE -f LICENSE -d packages
      - name: Check for fix license inconsistency
        run: |
          if [[ -n $(git status -s) ]]; then exit 1; fi
  fix:
    if: ${{ failure() }}
    needs: check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: dart-lang/setup-dart@v1.3
      - name: Install dependencies
        run: dart pub get
        working-directory: tools
      - name: Fix license consistency
        run: dart run tools/license_consistency.dart -l LICENSE -f LICENSE -d packages
      - name: Commit changes
        run: |
          git config --local user.email "${{ github.actor }}@users.noreply.github.com"
          git config --local user.name "${{ github.actor }}"
          git add .
          git commit -m "fix(license): Fix license inconsistency" -s
      - name: Push changes
        run: git push